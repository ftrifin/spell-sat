// ################################################################################
// FILE       : SPELLserverCif.H
// DATE       : Mar 17, 2011
// PROJECT    : SPELL
// DESCRIPTION: Client interface for server environment
// --------------------------------------------------------------------------------
//
//  Copyright (C) 2008, 2011 SES ENGINEERING, Luxembourg S.A.R.L.
//
//  This file is part of SPELL.
//
// SPELL is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// SPELL is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with SPELL. If not, see <http://www.gnu.org/licenses/>.
//
// ################################################################################

#ifndef __SPELL_SERVER_CIF_H__
#define __SPELL_SERVER_CIF_H__

// FILES TO INCLUDE ////////////////////////////////////////////////////////
// System includes ---------------------------------------------------------
// Local includes ----------------------------------------------------------
#include "SPELL_CIFS/SPELLrequestProcessor.H"
#include "SPELL_CIFS/SPELLdisplayBuffer.H"
// Project includes --------------------------------------------------------
#include "SPELL_SYN/SPELLthread.H"
#include "SPELL_CIF/SPELLcif.H"
#include "SPELL_IPC/SPELLipcClientInterface.H"
#include "SPELL_IPC/SPELLipcInterfaceListener.H"

/** \defgroup SPELL_CIFS Server-IPC client interface (SPELL_CIFS)
 *
 * This module defines the IPC client interface used by the Executor to
 * communicate with its associated GUIs.
 *
 * */
/*@{*/


// FORWARD REFERENCES //////////////////////////////////////////////////////
// TYPES ///////////////////////////////////////////////////////////////////
// DEFINES /////////////////////////////////////////////////////////////////
/** Timeout for the login message response */
#define SPELL_CIF_LOGIN_TIMEOUT_SEC        10
/** Timeout for the notification responses */
#define SPELL_CIF_NOTIFICATION_TIMEOUT_SEC 10
/** Timeout for the prompt responses (no timeout means wait forever */
#define SPELL_CIF_PROMPT_TIMEOUT_SEC       0
/** Timeout for opening a subprocedure */
#define SPELL_CIF_OPENPROC_TIMEOUT_SEC     30
/** General timeout for context requests */
#define SPELL_CIF_CTXREQUEST_TIMEOUT_SEC   10

//============================================================================
/** String mappings for notification types */
static std::string NOTIF_TYPE_STR[] =
{
    MessageValue::DATA_NOTIF_TYPE_ITEM,
    MessageValue::DATA_NOTIF_TYPE_VAL,
    MessageValue::DATA_NOTIF_TYPE_VERIF,
    MessageValue::DATA_NOTIF_TYPE_EXEC,
    MessageValue::DATA_NOTIF_TYPE_SYS,
    MessageValue::DATA_NOTIF_TYPE_TIME
};

//////////////////////////////////////////////////////////////////////////////
/**
 ** \brief IPC based client interface
 **
 ** \par Description and usage:
 **
 ** 	This implementation of SPELLcif uses the IPC layer to
 **  	connect to a SPELL context process.
 **
**////////////////////////////////////////////////////////////////////////////
class SPELLserverCif: public SPELLcif, public SPELLipcInterfaceListener
{
public: //--------------------------------------------------------------------

    // EXCEPTIONS ////////////////////////////////////////////////////////////
    // ENUMS /////////////////////////////////////////////////////////////////
    // TYPES /////////////////////////////////////////////////////////////////
    // LIFECYCLE /////////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////////////////
		/** Constructor.
		**////////////////////////////////////////////////////////////////////
		SPELLserverCif();

		//////////////////////////////////////////////////////////////////////
		/** Destructor.
		**////////////////////////////////////////////////////////////////////
		virtual ~SPELLserverCif();

	// STATIC ////////////////////////////////////////////////////////////////
	// METHODS ///////////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////////////////
		/** Setup the interface.
		 *
		 * \see SPELLcif::setup()
		**////////////////////////////////////////////////////////////////////
		void setup( const std::string& procId, const std::string& ctxName, int ctxPort, const std::string& timeId );

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif::cleanup()
		**////////////////////////////////////////////////////////////////////
		void cleanup( bool force );

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif::canClose()
		**////////////////////////////////////////////////////////////////////
		void canClose();

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif::waitClose()
		**////////////////////////////////////////////////////////////////////
		void waitClose();

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif::resetClose()
		**////////////////////////////////////////////////////////////////////
		void resetClose();

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif::getArguments()
		**////////////////////////////////////////////////////////////////////
		std::string getArguments() {
			return m_arguments;
		};

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif::getCondition()
		**////////////////////////////////////////////////////////////////////
		std::string getCondition() {
			return m_condition;
		};

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif::isAutomatic()
		**////////////////////////////////////////////////////////////////////
		bool isAutomatic() {
			return m_automatic;
		};

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif::isVisible()
		**////////////////////////////////////////////////////////////////////
		bool isVisible() {
			return m_visible;
		};

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif::isBlocking()
		**////////////////////////////////////////////////////////////////////
		bool isBlocking() {
			return m_blocking;
		};

    //====================================================================
    // IPC callbacks
    //====================================================================

		//////////////////////////////////////////////////////////////////////
		/** Process IPC messages.
		 *
		 * \param msg IN: message coming from the controlling GUI via the
		 *  SPELL context.
		**////////////////////////////////////////////////////////////////////
		void processMessage( SPELLipcMessage* msg );

		//////////////////////////////////////////////////////////////////////
		/** Process IPC requests.
		 *
		 * \param msg IN: request coming from the controlling GUI via the
		 * SPELL context.
		 *
		 * \returns The response message to be sent back to the GUI.
		**////////////////////////////////////////////////////////////////////
		SPELLipcMessage* processRequest( SPELLipcMessage* msg );

		//////////////////////////////////////////////////////////////////////
		/** Process IPC errors.
		 *
		 * \param error IN: error description.
		 * \param reason IN: error reason.
		**////////////////////////////////////////////////////////////////////
		void processError( std::string error, std::string reason );

    //====================================================================
    // Python bindings start (\see SPELLcif class)
    //====================================================================

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		void notifyLine();

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		void notifyCall();

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		void notifyReturn();

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		void notifyStatus( const SPELLstatusInfo& st );

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		void notifyUserActionSet( const std::string& label, const unsigned int severity );

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		void notifyUserActionUnset();

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		void notifyUserActionEnable( bool enable );

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		void notify( ItemNotification notification );

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		void notifyError( const std::string& error, const std::string& reason, bool fatal );

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		void write( const std::string& msg, unsigned int scope );

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		void warning( const std::string& msg, unsigned int scope );

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		void error( const std::string& msg, unsigned int scope );

		//////////////////////////////////////////////////////////////////////
		/** \see SPELLcif class.
		**////////////////////////////////////////////////////////////////////
		std::string prompt( const std::string& message, PromptOptions options, unsigned int type, unsigned int scope );

		//////////////////////////////////////////////////////////////////////
		/** Notify a variable change.
		**////////////////////////////////////////////////////////////////////
		void notifyVariableChange(const std::vector<SPELLvarInfo>& changed );

		//////////////////////////////////////////////////////////////////////
		/** Notify a variable scope change.
		**////////////////////////////////////////////////////////////////////
		void notifyVariableScopeChange( const SPELLscopeInfo& info );

		//////////////////////////////////////////////////////////////////////
		/** Open subprocedure.
		 *
		 * \param procId IN: identifier of the subprocedure
		 * \param args IN: arguments for the subprocedure
		 * \param automatic IN: automatic mode flag
		 * \param blocking IN: blocking mode flag
		 * \param visible IN: visible mode flag
		 *
		 * \returns The procedure identifier with instance number.
		**////////////////////////////////////////////////////////////////////
		std::string openSubprocedure( const std::string& procId,
									  const std::string& args, bool automatic, bool blocking, bool visible );

		//////////////////////////////////////////////////////////////////////
		/** Close the given child procedure.
		 *
		 * \param procId IN: child procedure identifier.
		**////////////////////////////////////////////////////////////////////
		void closeSubprocedure( const std::string& procId );

		//////////////////////////////////////////////////////////////////////
		/** Kill the given child procedure.
		 *
		 * \param procId IN: child procedure identifier.
		**////////////////////////////////////////////////////////////////////
		void killSubprocedure( const std::string& procId );

    //====================================================================
    // Python bindings end
    //====================================================================

    // DATA MEMBERS //////////////////////////////////////////////////////////

protected: //-----------------------------------------------------------------

		friend class SPELLdisplayBuffer;

    // EXCEPTIONS ////////////////////////////////////////////////////////////
    // ENUMS /////////////////////////////////////////////////////////////////
    // TYPES /////////////////////////////////////////////////////////////////
    // STATIC ////////////////////////////////////////////////////////////////
    // LIFECYCLE /////////////////////////////////////////////////////////////
    // METHODS ///////////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////////////////
		/** Send a request to the controlling GUI.
		 *
		 * \param msg IN: request to be sent.
		 * \param timeoutSec IN: timeout for the request
		 * \returns The request response.
		**////////////////////////////////////////////////////////////////////
		SPELLipcMessage* sendGUIRequest( SPELLipcMessage* msg, unsigned long timeoutSec );

		//////////////////////////////////////////////////////////////////////
		/** Send a message to the controlling GUI.
		 *
		 * \param msg IN: message to be sent.
		**////////////////////////////////////////////////////////////////////
		void sendGUIMessage( SPELLipcMessage* msg );

		//////////////////////////////////////////////////////////////////////
		/** Send a request to the context.
		 *
		 * \param msg IN: request to be sent.
		 * \param timeoutSec IN: timeout for the request.
		 *
		 * \returns The request response.
		**////////////////////////////////////////////////////////////////////
		SPELLipcMessage* sendCTXRequest( SPELLipcMessage* msg, unsigned long timeoutSec );

		//////////////////////////////////////////////////////////////////////
		/** Send a message to the context.
		 *
		 * \param msg IN: message to be sent.
		**////////////////////////////////////////////////////////////////////
		void sendCTXMessage( SPELLipcMessage* msg );

		//////////////////////////////////////////////////////////////////////
		/** Complete a message for the GUI.
		 *
		 * \param msg IN: message or request to be sent
		 *
		 *////////////////////////////////////////////////////////////////////
		void completeMessage( SPELLipcMessage* msg );

		//////////////////////////////////////////////////////////////////////
		/** Get message timestamp.
		**////////////////////////////////////////////////////////////////////
		std::string getTimestampUsec();

    // DATA MEMBERS //////////////////////////////////////////////////////////

private: //-------------------------------------------------------------------

    // EXCEPTIONS ////////////////////////////////////////////////////////////
    // ENUMS /////////////////////////////////////////////////////////////////
    // TYPES /////////////////////////////////////////////////////////////////
    // LIFECYCLE /////////////////////////////////////////////////////////////
    // METHODS ///////////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////////////////
		/** Send the login message to the SPELL context.
		 *
		 * \returns The login response from the context.
		**////////////////////////////////////////////////////////////////////
		SPELLipcMessage* login();

		//////////////////////////////////////////////////////////////////////
		/** Send the logout message to the SPELL context.
		**////////////////////////////////////////////////////////////////////
		void logout();

		//////////////////////////////////////////////////////////////////////
		/** Process the login response and extract configuration parameters.
		 *
		 * \param loginResp IN: response sent by context after login.
		**////////////////////////////////////////////////////////////////////
		void processLogin( SPELLipcMessage* loginResp );

		//////////////////////////////////////////////////////////////////////
		/** Process messages regarding GUI commands
		**////////////////////////////////////////////////////////////////////
		void processMessageCommand( SPELLipcMessage* msg );

    // DATA MEMBERS //////////////////////////////////////////////////////////
		/** Holds the IPC interface to communicate with the SPELL context */
		SPELLipcClientInterface* m_ifc;
		/** Buffer to accumulate display messages */
		SPELLdisplayBuffer* m_buffer;
		/** Visible mode flag */
		bool m_visible;
		/** Blocking mode flag */
		bool m_blocking;
		/** Automatic mode flag */
		bool m_automatic;
		/** Identifier of the controlling GUI */
		std::string m_controlGui;
		/** Host of the controlling GUI */
		std::string m_controlHost;
		/** Arguments for procedure execution, given by context */
		std::string m_arguments;
		/** Condition for procedure execution, given by context */
		std::string m_condition;
		/** Event for cleaning up connections */
		SPELLevent m_finishEvent;
		/** True when the CIF is ready to work */
		bool m_ready;
		/** True when the CIF should talk to the GUI */
		bool m_useGUI;
		/** Optimization: write message skeleton */
		SPELLipcMessage m_wrMessage;
		/** Optimization: line notification request skeleton */
		SPELLipcMessage m_lnMessage;
		/** Optimization: item notification request skeleton */
		SPELLipcMessage m_ntMessage;
		/** Optimization: status notification request skeleton */
		SPELLipcMessage m_stMessage;
		/** Optimization: prevent redundant line notifications */
		std::string m_lastStack;
		/** Processes incoming messages and requests */
		SPELLrequestProcessor m_processor;
		/** Sequence counter */
		unsigned long m_sequence;
		/** Stack sequence counter */
		unsigned long m_sequenceStack;
};

/*@}*/
#endif
