// ################################################################################
// FILE       : SPELLvariableMonitor.H
// DATE       : Mar 17, 2011
// PROJECT    : SPELL
// DESCRIPTION: Monitor for runtime procedure variables
// --------------------------------------------------------------------------------
//
//  Copyright (C) 2008, 2011 SES ENGINEERING, Luxembourg S.A.R.L.
//
//  This file is part of SPELL.
//
// SPELL is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// SPELL is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with SPELL. If not, see <http://www.gnu.org/licenses/>.
//
// ################################################################################

#ifndef __SPELL_VAR_MONITOR_H__
#define __SPELL_VAR_MONITOR_H__

// FILES TO INCLUDE ////////////////////////////////////////////////////////
// System includes ---------------------------------------------------------
// Local includes ----------------------------------------------------------
#include "SPELL_EXC/SPELLvarInfo.H"
// Project includes --------------------------------------------------------
#include "SPELL_UTIL/SPELLbase.H"

/** \addtogroup SPELL_EXC */
/*@{*/


// FORWARD REFERENCES //////////////////////////////////////////////////////
// TYPES ///////////////////////////////////////////////////////////////////
// DEFINES /////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////
/**
 ** \brief Listener for variable changes.
 **
**////////////////////////////////////////////////////////////////////////////
class SPELLvariableChangeListener
{
public:

	//////////////////////////////////////////////////////////////////////
	/** Destructor.
	**////////////////////////////////////////////////////////////////////
	virtual ~SPELLvariableChangeListener() {;};

	//////////////////////////////////////////////////////////////////////
	/** Notify about a variable change.
	 *
	 * \param changed IN: list of changed variables.
	 *
	**////////////////////////////////////////////////////////////////////
	virtual void variableChanged( const std::vector<SPELLvarInfo>& changed ) = 0;

};

//////////////////////////////////////////////////////////////////////////////
/**
 ** \brief Monitor of variables
 **
 ** \par Description and usage:
 **
 ** 	Used to implement the watch-of-variables mechanism
 **
**////////////////////////////////////////////////////////////////////////////
class SPELLvariableMonitor
{
public: //--------------------------------------------------------------------

    // EXCEPTIONS ////////////////////////////////////////////////////////////
    // ENUMS /////////////////////////////////////////////////////////////////
    // TYPES /////////////////////////////////////////////////////////////////
    // LIFECYCLE /////////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////////////////
		/** Constructor.
		**////////////////////////////////////////////////////////////////////
		SPELLvariableMonitor( SPELLvariableChangeListener* listener,
							  PyFrameObject* frame,
							  std::set<std::string>& initialVariables );

		//////////////////////////////////////////////////////////////////////
		/** Destructor.
		**////////////////////////////////////////////////////////////////////
		~SPELLvariableMonitor();

    // STATIC ////////////////////////////////////////////////////////////////
    // METHODS ///////////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////////////////
		/** Get currently available variables.
		 *
		 * \return The list of variables.
		**////////////////////////////////////////////////////////////////////
		std::vector<SPELLvarInfo> getAllVariables();

		//////////////////////////////////////////////////////////////////////
		/** Get currently registered variables.
		 *
		 * \return The list of variables.
		**////////////////////////////////////////////////////////////////////
		std::vector<SPELLvarInfo> getRegisteredVariables();

		//////////////////////////////////////////////////////////////////////
		/** Get currently available global variables.
		 *
		 * \return The list of variables.
		**////////////////////////////////////////////////////////////////////
		std::vector<SPELLvarInfo> getGlobalVariables();

		//////////////////////////////////////////////////////////////////////
		/** Get currently registered global variables.
		 *
		 * \return The list of variables.
		**////////////////////////////////////////////////////////////////////
		std::vector<SPELLvarInfo> getRegisteredGlobalVariables();

		//////////////////////////////////////////////////////////////////////
		/** Get currently available local variables.
		 *
		 * \return The list of variables.
		**////////////////////////////////////////////////////////////////////
		std::vector<SPELLvarInfo> getLocalVariables();

		//////////////////////////////////////////////////////////////////////
		/** Get currently registered global variables.
		 *
		 * \return The list of variables.
		**////////////////////////////////////////////////////////////////////
		std::vector<SPELLvarInfo> getRegisteredLocalVariables();

		//////////////////////////////////////////////////////////////////////
		/** Register a variable in the current frame.
		 *
		 * \param var INOUT: the variable information
		 *
		 * \return True if success.
		**////////////////////////////////////////////////////////////////////
		bool registerVariable( SPELLvarInfo& var );

		//////////////////////////////////////////////////////////////////////
		/** Unregister a variable in the current frame.
		 *
		 * \param var IN: the variable to unregister.
		 *
		**////////////////////////////////////////////////////////////////////
		void unregisterVariable( SPELLvarInfo& var );

		//////////////////////////////////////////////////////////////////////
		/** Change variable
		 *
		 * \param var IN: the variable to change.
		 *
		**////////////////////////////////////////////////////////////////////
		void changeVariable( SPELLvarInfo& var );

		//////////////////////////////////////////////////////////////////////
		/** Unregister all variables.
		**////////////////////////////////////////////////////////////////////
		void unregisterAll();

		//////////////////////////////////////////////////////////////////////
		/** Get variable value.
		 *
		 * \param varName IN: variable name
		 *
		 * \return The variable information.
		**////////////////////////////////////////////////////////////////////
		void getVariable( SPELLvarInfo& var );

		//////////////////////////////////////////////////////////////////////
		/** Analyze variable dictionary to detect changes.
		**////////////////////////////////////////////////////////////////////
		void analyze();

protected: //-----------------------------------------------------------------

    // EXCEPTIONS ////////////////////////////////////////////////////////////
    // ENUMS /////////////////////////////////////////////////////////////////
    // TYPES /////////////////////////////////////////////////////////////////
    // LIFECYCLE /////////////////////////////////////////////////////////////
    // METHODS ///////////////////////////////////////////////////////////////
    // DATA MEMBERS //////////////////////////////////////////////////////////

private: //-------------------------------------------------------------------

    // EXCEPTIONS ////////////////////////////////////////////////////////////
    // ENUMS /////////////////////////////////////////////////////////////////
    // TYPES /////////////////////////////////////////////////////////////////

		/** Type for variable name-value map */
		typedef std::map<std::string,SPELLvarInfo> VarMap;

    // LIFECYCLE /////////////////////////////////////////////////////////////
    // METHODS ///////////////////////////////////////////////////////////////

		//////////////////////////////////////////////////////////////////////
		/** Check if a variable is registered.
		 *
		 * \param varName IN: name of the variable.
		 *
		 * \return True if the variable is registered.
		**////////////////////////////////////////////////////////////////////
		bool isRegistered( const std::string& varName );

		//////////////////////////////////////////////////////////////////////
		/** Retrieve existing local variables in the current execution frame
		 *  \param vars INOUT: vector of variable information to fill.
		 *
		**////////////////////////////////////////////////////////////////////
		void retrieveLocalVariables(std::vector<SPELLvarInfo>& vars);

		//////////////////////////////////////////////////////////////////////
		/** Retrieve existing global variables in the current execution frame
		 *  \param vars INOUT: vector of variable information to fill.
		 *  \param locals IN: vector of variable names found in local scope
		 **///////////////////////////////////////////////////////////////////
		void retrieveGlobalVariables(std::vector<SPELLvarInfo>& vars,
									 std::set<std::string> locals);

		//////////////////////////////////////////////////////////////////////
		/** Build the required variable names
		**////////////////////////////////////////////////////////////////////
		std::vector<std::string> retrieveNames();

    // DATA MEMBERS //////////////////////////////////////////////////////////

		/** Reference to the frame */
		PyFrameObject* m_frame;
		/** Reference to the single change listener */
		SPELLvariableChangeListener* m_listener;
		/** Map of registered variables */
		VarMap m_variables;
		/** Map of initial variables to discard on any request */
		std::set<std::string>& m_initialVariables;
};

/*@}*/
#endif
